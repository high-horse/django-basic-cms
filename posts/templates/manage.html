{% extends 'layout.html' %}

{% block title %}
{{ title|default_if_none:"MY HOME PAGE" }}
{% endblock %}

{% block content %}
<div class="mx-5 my-5"">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Posts Management</h2>

        <!-- Add New Post Button -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPostModal">
            + Add Post
        </button>
    </div>

    {% if posts %}
    <table class="table table-striped table-bordered align-middle" id="postsTable">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Content</th>
                <th>Image</th>
                <th>Featured</th>
                <!-- <th>Created At</th>
                <th>Updated At</th> -->
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for post in posts %}
            <tr id="postRow{{ post.id }}">
                <td>{{ post.title }}</td>
                <td>{{ post.description|default:"No description available" }}</td>
                <td>{{ post.content|truncatechars:50|default:"No content available" }}</td>

                <td>
                    {% if post.image %}
                    <img src="{{ post.image.url }}" alt="{{ post.title }}" width="100">
                    {% else %}
                    <span class="text-muted">No image</span>
                    {% endif %}
                </td>
                <td>{{ post.is_featured }}</td>
                <td>
                    <!-- Edit Button -->
                    <button type="button" class="btn btn-warning btn-sm edit-btn" 
                        data-bs-toggle="modal"
                        data-bs-target="#editPostModal"
                        data-id="{{ post.id }}"
                        data-title="{{ post.title|default_if_none:''|escape }}"
                        data-description="{{ post.description|default_if_none:''|escape }}"
                        data-content="{{ post.content|default_if_none:''|escape }}"
                        data-is-featured="{{ post.is_featured }}">
                        Edit
                    </button>



                    <!-- Delete Button -->
                    <button class="btn btn-danger btn-sm delete-btn" data-id="{{ post.id }}">
                        Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No posts available.</p>
    {% endif %}

    <!-- Add Post Modal -->
    <div class="modal fade" id="addPostModal" tabindex="-1" aria-labelledby="addPostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addPostForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPostModalLabel">Add New Post</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="addTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="addDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="addDescription" name="description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="addContent" class="form-label">Contents</label>
                            <textarea class="form-control" id="addContent" name="content"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="addImage" class="form-label">Image</label>
                            <input type="file" class="form-control" id="addImage" name="image">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="addFeatured" name="is_featured">
                            <label class="form-check-label" for="addFeatured">Featured</label>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Post</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" id="editPostForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="editTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" name="description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editContent" class="form-label">Contents</label>
                            <textarea class="form-control" id="editContent" name="content"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editImage" class="form-label">Image</label>
                            <input type="file" class="form-control" id="editImage" name="image">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editFeatured" name="is_featured">
                            <label class="form-check-label" for="editFeatured">Featured</label>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // CSRF setup for AJAX
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    $(document).ready(function () {

        // Add Post AJAX
        $('#addPostForm').submit(function (e) {
            e.preventDefault();
            let formData = new FormData(this);

            $.ajax({
                url: "{% url 'post_create' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    $('#addPostModal').modal('hide');
                    $('#addPostForm')[0].reset();
                    location.reload();
                },
                error: function (xhr) {
                    alert('Error adding post.');
                    console.log(xhr.responseText);
                }
            });
        });

        // Edit Button Click - Populate Modal
        $('.edit-btn').click(function () {
            const postId = $(this).data('id');
            const title = $(this).data('title');
            const description = $(this).data('description');
            const content = $(this).data('content');
            const is_featured = $(this).data('is-featured'); // new attribute

            $('#editPostForm').attr('action', "{% url 'post_edit' 0 %}".replace('0', postId));
            $('#editTitle').val(title);
            $('#editDescription').val(description);
            $('#editContent').val(content);
            $('#editImage').val('');
            $('#editFeatured').prop('checked', is_featured); // set checkbox
        });


        // Edit Post AJAX
        $('#editPostForm').submit(function (e) {
            e.preventDefault();
            const url = $(this).attr('action');
            const formData = new FormData(this);

            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    $('#editPostModal').modal('hide');
                    location.reload();
                },
                error: function (xhr) {
                    alert('Error updating post.');
                    console.log(xhr.responseText);
                }
            });
        });

        // Delete Post AJAX
        $('.delete-btn').click(function () {
            if (!confirm('Are you sure you want to delete this post?')) return;

            const postId = $(this).data('id');

            $.ajax({
                url: "{% url 'post_delete' 0 %}".replace('0', postId),
                type: 'POST',
                data: { csrfmiddlewaretoken: csrftoken },
                success: function () {
                    $('#postRow' + postId).remove();
                },
                error: function (xhr) {
                    alert('Error deleting post.');
                    console.log(xhr.responseText);
                }
            });
        });

    });
</script>

{% endblock %}