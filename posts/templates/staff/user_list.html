{% extends "staff/layout.html" %}

{% block title %}Users{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Users Management</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">+ Add User</button>
    </div>

    {% if page_obj %}
    <table class="table table-bordered" id="usersTable">
        <thead class="">
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in page_obj %}
            <tr id="userRow{{ user.id }}">
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email|default:"-" }}</td>
                <td>{{ user.is_staff|yesno:"Staff,Guest" }}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-btn"
                        data-id="{{ user.id }}"
                        data-username="{{ user.username|escape }}"
                        data-email="{{ user.email|default_if_none:''|escape }}"
                        data-is-staff="{{ user.is_staff }}"
                        data-bs-toggle="modal" data-bs-target="#editUserModal">
                        Edit
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="{{ user.id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>

    {% else %}
        <p class="text-muted">No users found.</p>
    {% endif %}
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addUserForm">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="is_staff">
                        <label class="form-check-label">Staff</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editUserForm">
            {% csrf_token %}
            <input type="hidden" id="editUserId">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email">
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="editIsStaff" name="is_staff">
                        <label class="form-check-label">Staff</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
const csrftoken = '{{ csrf_token }}';

// Add User
$('#addUserForm').submit(function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    $.post("{% url 'staff_user_create' %}", formData, function(data) {
        location.reload();
    }).fail(function(xhr){
        alert("Error adding user");
        console.log(xhr.responseText);
    });
});

// Populate Edit Modal
$('.edit-btn').click(function() {
    const id = $(this).data('id');
    $('#editUserId').val(id);
    $('#editUsername').val($(this).data('username'));
    $('#editEmail').val($(this).data('email'));
    $('#editIsStaff').prop('checked', $(this).data('is-staff'));
    $('#editUserForm').attr('action', "/staff/users/" + id + "/edit/");
});

// Edit User
$('#editUserForm').submit(function(e) {
    e.preventDefault();
    const id = $('#editUserId').val();
    const formData = $(this).serialize();
    $.post("/staff/users/" + id + "/edit/", formData, function(data) {
        location.reload();
    }).fail(function(xhr){
        alert("Error updating user");
        console.log(xhr.responseText);
    });
});

// Delete User
$('.delete-btn').click(function() {
    if(!confirm("Are you sure you want to delete this user?")) return;
    const id = $(this).data('id');
    $.post("/staff/users/" + id + "/delete/", {csrfmiddlewaretoken: csrftoken}, function() {
        $('#userRow'+id).remove();
    }).fail(function(xhr){
        alert("Error deleting user");
        console.log(xhr.responseText);
    });
});
</script>
{% endblock %}
