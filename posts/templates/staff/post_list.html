{% extends "staff/layout.html" %}

{% block title %}Posts{% endblock %}

{% block content %}
<div class="">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Posts Management</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPostModal">+ Add Post</button>
    </div>

    {% if page_obj %}
    <!-- <table class="table table-bordered" id="categoryTable"></table> -->
    <table class="table table-bordered" id="postsTable">
        <thead >
            <tr>
                <!-- class="bg-primary text-white" -->
                <th >Title</th>
                <th >Description</th>
                <th >Content</th>
                <th >Category</th>
                <th >Image</th>
                <th >Featured</th>
                <th >Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for post in page_obj %}
            <tr id="postRow{{ post.id }}">
                <td>{{ post.title }}</td>
                <td>{{ post.description|truncatewords:30|default:"-" }}</td>
                <td>{{ post.content|truncatewords:10|default:"-"|safe }}</td>
                <td>{{ post.category.name|default_if_none:"-" }}</td>
                <td>
                    {% if post.image %}
                        <img src="{{ post.image.url }}" alt="{{ post.title }}" width="100">
                    {% else %}
                        <span class="text-muted">No image</span>
                    {% endif %}
                </td>
                <td>{{ post.is_featured }}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-btn"
                        data-id="{{ post.id }}"
                        data-title="{{ post.title|escape }}"
                        data-description="{{ post.description|default_if_none:''|escape }}"
                        data-content="{{ post.content|default_if_none:''|escape }}"
                        data-category-id="{{ post.category.id|default_if_none:'' }}"
                        data-is-featured="{{ post.is_featured }}"
                        data-bs-toggle="modal" data-bs-target="#editPostModal">
                        Edit
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="{{ post.id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>

    {% else %}
        <p class="text-muted">No posts available.</p>
    {% endif %}
</div>

<!-- Add Post Modal -->
<div class="modal fade" id="addPostModal" tabindex="-1" aria-labelledby="addPostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addPostForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPostModalLabel">Add New Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="addTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="addDescription" name="description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="addContent" class="form-label">Content</label>
                        <textarea class="form-control" id="addContent" name="content"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="addCategory" class="form-label">Category</label>
                        <select class="form-select" id="addCategory" name="category">
                            <option value="">-- Select Category --</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="addImage" name="image">
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="addFeatured" name="is_featured">
                        <label class="form-check-label" for="addFeatured">Featured</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Post</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Post Modal -->
<div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editPostForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPostId">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">Content</label>
                        <textarea class="form-control" id="editContent" name="content"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">Category</label>
                        <select class="form-select" id="editCategory" name="category">
                            <option value="">-- Select Category --</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="editImage" name="image">
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="editFeatured" name="is_featured">
                        <label class="form-check-label" for="editFeatured">Featured</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
const csrftoken = '{{ csrf_token }}';

let addEditor, editEditor;

ClassicEditor
    .create(document.querySelector('#addContent'))
    .then(editor => {
        addEditor = editor; // Store the editor instance for later use
    })
    .catch(error => {
        console.error(error);
    });

ClassicEditor
    .create(document.querySelector('#editContent'))
    .then(editor => {
        editEditor = editor; // Store the editor instance for later use
    })
    .catch(error => {
        console.error(error);
    });


// Add Post
$('#addPostForm').submit(function(e) {
    e.preventDefault();
    let formData = new FormData(this);
    formData.append('content', addEditor.getData());
    $.ajax({
        url: "{% url 'staff_post_create' %}",
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            location.reload();
        },
        error: function(xhr) {
            alert('Error adding post');
            console.log(xhr.responseText);
        }
    });
});

// Populate Edit Modal
$('.edit-btn').click(function() {
    const postId = $(this).data('id');
    $('#editPostId').val(postId);
    $('#editTitle').val($(this).data('title'));
    $('#editDescription').val($(this).data('description'));
    $('#editContent').val($(this).data('content'));
    $('#editCategory').val($(this).data('category-id'));
    $('#editFeatured').prop('checked', $(this).data('is-featured'));
    $('#editPostForm').attr('action', "/posts/" + postId + "/edit/");

    const existingContent = $(this).data('content');
    editEditor.setData(existingContent);  
});

// Edit Post
$('#editPostForm').submit(function(e) {
    e.preventDefault();
    const url = $(this).attr('action');
    const formData = new FormData(this);
    formData.append('content', editEditor.getData());  

    $.ajax({
        url: url,
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            location.reload();
        },
        error: function(xhr) {
            alert('Error updating post');
            console.log(xhr.responseText);
        }
    });
});

// Delete Post
$('.delete-btn').click(function() {
    if(!confirm("Are you sure you want to delete this post?")) return;
    const postId = $(this).data('id');
    $.ajax({
        url: "/posts/" + postId + "/delete/",
        method: "POST",
        data: {csrfmiddlewaretoken: csrftoken},
        success: function() {
            $('#postRow'+postId).remove();
        },
        error: function(xhr) {
            alert('Error deleting post');
            console.log(xhr.responseText);
        }
    });
});
</script>

<style>
    .ck-editor__editable {
    min-height: 200px; /* Set minimum height for the editor */
}
</style>
{% endblock %}
